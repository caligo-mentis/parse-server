"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FilesRouter = void 0;

var _express = _interopRequireDefault(require("express"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var Middlewares = _interopRequireWildcard(require("../middlewares"));

var _node = _interopRequireDefault(require("parse/node"));

var _Config = _interopRequireDefault(require("../Config"));

var _mime = _interopRequireDefault(require("mime"));

var _logger = _interopRequireDefault(require("../logger"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class FilesRouter {
  expressRouter({
    maxUploadSize = '20Mb'
  } = {}) {
    var router = _express.default.Router();

    router.get('/files/:appId/:filename', this.getHandler);
    router.post('/files', function (req, res, next) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename not provided.'));
    });
    router.post('/files/:filename', _bodyParser.default.raw({
      type: () => {
        return true;
      },
      limit: maxUploadSize
    }), // Allow uploads without Content-Type, or with any Content-Type.
    Middlewares.handleParseHeaders, this.createHandler);
    router.delete('/files/:filename', Middlewares.handleParseHeaders, Middlewares.enforceMasterKeyAccess, this.deleteHandler);
    return router;
  }

  getHandler(req, res) {
    const config = _Config.default.get(req.params.appId);

    const filesController = config.filesController;
    const range = req.get('Range');
    const filename = req.params.filename;
    res.set('Content-Type', _mime.default.getType(filename));
    filesController.getFileProperties(config, filename).then(properties => {
      const {
        length
      } = properties;
      let options;

      if (range) {
        options = getRange(range);
        const {
          start = 0,
          end = length
        } = options;
        res.writeHead(206, {
          'Accept-Ranges': 'bytes',
          'Content-Range': `bytes ${start}-${end}/${length}`,
          'Content-Length': end - start + 1
        });
      } else {
        res.status(200);
        res.set('Content-Length', length);
      }

      return filesController.getFileStream(config, filename, options);
    }).then(stream => stream.pipe(res)).catch(() => fileNotFound(res));
  }

  createHandler(req, res, next) {
    if (!req.body || !req.body.length) {
      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, 'Invalid file upload.'));
      return;
    }

    if (req.params.filename.length > 128) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename too long.'));
      return;
    }

    if (!req.params.filename.match(/^[_a-zA-Z0-9][a-zA-Z0-9@\.\ ~_-]*$/)) {
      next(new _node.default.Error(_node.default.Error.INVALID_FILE_NAME, 'Filename contains invalid characters.'));
      return;
    }

    const filename = req.params.filename;
    const contentType = req.get('Content-type');
    const config = req.config;
    const filesController = config.filesController;
    filesController.createFile(config, filename, req.body, contentType).then(result => {
      res.status(201);
      res.set('Location', result.url);
      res.json(result);
    }).catch(e => {
      _logger.default.error('Error creating a file: ', e);

      next(new _node.default.Error(_node.default.Error.FILE_SAVE_ERROR, `Could not store file: ${filename}.`));
    });
  }

  deleteHandler(req, res, next) {
    const filesController = req.config.filesController;
    filesController.deleteFile(req.config, req.params.filename).then(() => {
      res.status(200); // TODO: return useful JSON here?

      res.end();
    }).catch(() => {
      next(new _node.default.Error(_node.default.Error.FILE_DELETE_ERROR, 'Could not delete file.'));
    });
  }

}

exports.FilesRouter = FilesRouter;

function fileNotFound(res) {
  res.status(404);
  res.set('Content-Type', 'text/plain');
  res.end('File not found.');
}

function getRange(range) {
  const parts = range.replace(/bytes=/, '').split('-');
  return {
    start: parseInt(parts[0], 10),
    end: parts[1] ? parseInt(parts[1], 10) : undefined
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0ZpbGVzUm91dGVyLmpzIl0sIm5hbWVzIjpbIkZpbGVzUm91dGVyIiwiZXhwcmVzc1JvdXRlciIsIm1heFVwbG9hZFNpemUiLCJyb3V0ZXIiLCJleHByZXNzIiwiUm91dGVyIiwiZ2V0IiwiZ2V0SGFuZGxlciIsInBvc3QiLCJyZXEiLCJyZXMiLCJuZXh0IiwiUGFyc2UiLCJFcnJvciIsIklOVkFMSURfRklMRV9OQU1FIiwiQm9keVBhcnNlciIsInJhdyIsInR5cGUiLCJsaW1pdCIsIk1pZGRsZXdhcmVzIiwiaGFuZGxlUGFyc2VIZWFkZXJzIiwiY3JlYXRlSGFuZGxlciIsImRlbGV0ZSIsImVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiLCJkZWxldGVIYW5kbGVyIiwiY29uZmlnIiwiQ29uZmlnIiwicGFyYW1zIiwiYXBwSWQiLCJmaWxlc0NvbnRyb2xsZXIiLCJyYW5nZSIsImZpbGVuYW1lIiwic2V0IiwibWltZSIsImdldFR5cGUiLCJnZXRGaWxlUHJvcGVydGllcyIsInRoZW4iLCJwcm9wZXJ0aWVzIiwibGVuZ3RoIiwib3B0aW9ucyIsImdldFJhbmdlIiwic3RhcnQiLCJlbmQiLCJ3cml0ZUhlYWQiLCJzdGF0dXMiLCJnZXRGaWxlU3RyZWFtIiwic3RyZWFtIiwicGlwZSIsImNhdGNoIiwiZmlsZU5vdEZvdW5kIiwiYm9keSIsIkZJTEVfU0FWRV9FUlJPUiIsIm1hdGNoIiwiY29udGVudFR5cGUiLCJjcmVhdGVGaWxlIiwicmVzdWx0IiwidXJsIiwianNvbiIsImUiLCJsb2dnZXIiLCJlcnJvciIsImRlbGV0ZUZpbGUiLCJGSUxFX0RFTEVURV9FUlJPUiIsInBhcnRzIiwicmVwbGFjZSIsInNwbGl0IiwicGFyc2VJbnQiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7O0FBRU8sTUFBTUEsV0FBTixDQUFrQjtBQUN2QkMsRUFBQUEs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LEdBQUosQ0FBUSxjQUFSLEVBQXdCLFlBQXhCO0FBQ0F0QixFQUFBQSxHQUFHLENBQUNnQyxHQUFKLENBQVEsaUJBQVI7QUFDRDs7QUFFRCxTQUFTRixRQUFULENBQWtCVixLQUFsQixFQUF5QjtBQUN2QixRQUFNaUMsS0FBSyxHQUFHakMsS0FBSyxDQUFDa0MsT0FBTixDQUFjLFFBQWQsRUFBd0IsRUFBeEIsRUFBNEJDLEtBQTVCLENBQWtDLEdBQWxDLENBQWQ7QUFDQSxTQUFPO0FBQ0x4QixJQUFBQSxLQUFLLEVBQUV5QixRQUFRLENBQUNILEtBQUssQ0FBQyxDQUFELENBQU4sRUFBVyxFQUFYLENBRFY7QUFFTHJCLElBQUFBLEdBQUcsRUFBRXFCLEtBQUssQ0FBQyxDQUFELENBQUwsR0FBV0csUUFBUSxDQUFDSCxLQUFLLENBQUMsQ0FBRCxDQUFOLEVBQVcsRUFBWCxDQUFuQixHQUFvQ0k7QUFGcEMsR0FBUDtBQUlEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgQm9keVBhcnNlciBmcm9tICdib2R5LXBhcnNlcic7XG5pbXBvcnQgKiBhcyBNaWRkbGV3YXJlcyBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgUGFyc2UgZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgQ29uZmlnIGZyb20gJy4uL0NvbmZpZyc7XG5pbXBvcnQgbWltZSBmcm9tICdtaW1lJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi4vbG9nZ2VyJztcblxuZXhwb3J0IGNsYXNzIEZpbGVzUm91dGVyIHtcbiAgZXhwcmVzc1JvdXRlcih7IG1heFVwbG9hZFNpemUgPSAnMjBNYicgfSA9IHt9KSB7XG4gICAgdmFyIHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7XG4gICAgcm91dGVyLmdldCgnL2ZpbGVzLzphcHBJZC86ZmlsZW5hbWUnLCB0aGlzLmdldEhhbmRsZXIpO1xuXG4gICAgcm91dGVyLnBvc3QoJy9maWxlcycsIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgICBuZXh0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5WQUxJRF9GSUxFX05BTUUsICdGaWxlbmFtZSBub3QgcHJvdmlkZWQuJylcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICByb3V0ZXIucG9zdChcbiAgICAgICcvZmlsZXMvOmZpbGVuYW1lJyxcbiAgICAgIEJvZHlQYXJzZXIucmF3KHtcbiAgICAgICAgdHlwZTogKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9LFxuICAgICAgICBsaW1pdDogbWF4VXBsb2FkU2l6ZSxcbiAgICAgIH0pLCAvLyBBbGxvdyB1cGxvYWRzIHdpdGhvdXQgQ29udGVudC1UeXBlLCBvciB3aXRoIGFueSBDb250ZW50LVR5cGUuXG4gICAgICBNaWRkbGV3YXJlcy5oYW5kbGVQYXJzZUhlYWRlcnMsXG4gICAgICB0aGlzLmNyZWF0ZUhhbmRsZXJcbiAgICApO1xuXG4gICAgcm91dGVyLmRlbGV0ZShcbiAgICAgICcvZmlsZXMvOmZpbGVuYW1lJyxcbiAgICAgIE1pZGRsZXdhcmVzLmhhbmRsZVBhcnNlSGVhZGVycyxcbiAgICAgIE1pZGRsZXdhcmVzLmVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsXG4gICAgICB0aGlzLmRlbGV0ZUhhbmRsZXJcbiAgICApO1xuICAgIHJldHVybiByb3V0ZXI7XG4gIH1cblxuICBnZXRIYW5kbGVyKHJlcSwgcmVzKSB7XG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChyZXEucGFyYW1zLmFwcElkKTtcbiAgICBjb25zdCBmaWxlc0NvbnRyb2xsZXIgPSBjb25maWcuZmlsZXNDb250cm9sbGVyO1xuXG4gICAgY29uc3QgcmFuZ2UgPSByZXEuZ2V0KCdSYW5nZScpO1xuICAgIGNvbnN0IGZpbGVuYW1lID0gcmVxLnBhcmFtcy5maWxlbmFtZTtcblxuICAgIHJlcy5zZXQoJ0NvbnRlbnQtVHlwZScsIG1pbWUuZ2V0VHlwZShmaWxlbmFtZSkpO1xuXG4gICAgZmlsZXNDb250cm9sbGVyXG4gICAgICAuZ2V0RmlsZVByb3BlcnRpZXMoY29uZmlnLCBmaWxlbmFtZSlcbiAgICAgIC50aGVuKHByb3BlcnRpZXMgPT4ge1xuICAgICAgICBjb25zdCB7IGxlbmd0aCB9ID0gcHJvcGVydGllcztcbiAgICAgICAgbGV0IG9wdGlvbnM7XG5cbiAgICAgICAgaWYgKHJhbmdlKSB7XG4gICAgICAgICAgb3B0aW9ucyA9IGdldFJhbmdlKHJhbmdlKTtcblxuICAgICAgICAgIGNvbnN0IHsgc3RhcnQgPSAwLCBlbmQgPSBsZW5ndGggfSA9IG9wdGlvbnM7XG5cbiAgICAgICAgICByZXMud3JpdGVIZWFkKDIwNiwge1xuICAgICAgICAgICAgJ0FjY2VwdC1SYW5nZXMnOiAnYnl0ZXMnLFxuICAgICAgICAgICAgJ0NvbnRlbnQtUmFuZ2UnOiBgYnl0ZXMgJHtzdGFydH0tJHtlbmR9LyR7bGVuZ3RofWAsXG4gICAgICAgICAgICAnQ29udGVudC1MZW5ndGgnOiBlbmQgLSBzdGFydCArIDEsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVzLnN0YXR1cygyMDApO1xuICAgICAgICAgIHJlcy5zZXQoJ0NvbnRlbnQtTGVuZ3RoJywgbGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmaWxlc0NvbnRyb2xsZXIuZ2V0RmlsZVN0cmVhbShjb25maWcsIGZpbGVuYW1lLCBvcHRpb25zKTtcbiAgICAgIH0pXG4gICAgICAudGhlbihzdHJlYW0gPT4gc3RyZWFtLnBpcGUocmVzKSlcbiAgICAgIC5jYXRjaCgoKSA9PiBmaWxlTm90Rm91bmQocmVzKSk7XG4gIH1cblxuICBjcmVhdGVIYW5kbGVyKHJlcSwgcmVzLCBuZXh0KSB7XG4gICAgaWYgKCFyZXEuYm9keSB8fCAhcmVxLmJvZHkubGVuZ3RoKSB7XG4gICAgICBuZXh0KFxuICAgICAgICBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuRklMRV9TQVZFX0VSUk9SLCAnSW52YWxpZCBmaWxlIHVwbG9hZC4nKVxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAocmVxLnBhcmFtcy5maWxlbmFtZS5sZW5ndGggPiAxMjgpIHtcbiAgICAgIG5leHQoXG4gICAgICAgIG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0ZJTEVfTkFNRSwgJ0ZpbGVuYW1lIHRvbyBsb25nLicpXG4gICAgICApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghcmVxLnBhcmFtcy5maWxlbmFtZS5tYXRjaCgvXltfYS16QS1aMC05XVthLXpBLVowLTlAXFwuXFwgfl8tXSokLykpIHtcbiAgICAgIG5leHQoXG4gICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICBQYXJzZS5FcnJvci5JTlZBTElEX0ZJTEVfTkFNRSxcbiAgICAgICAgICAnRmlsZW5hbWUgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzLidcbiAgICAgICAgKVxuICAgICAgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlbmFtZSA9IHJlcS5wYXJhbXMuZmlsZW5hbWU7XG4gICAgY29uc3QgY29udGVudFR5cGUgPSByZXEuZ2V0KCdDb250ZW50LXR5cGUnKTtcbiAgICBjb25zdCBjb25maWcgPSByZXEuY29uZmlnO1xuICAgIGNvbnN0IGZpbGVzQ29udHJvbGxlciA9IGNvbmZpZy5maWxlc0NvbnRyb2xsZXI7XG5cbiAgICBmaWxlc0NvbnRyb2xsZXJcbiAgICAgIC5jcmVhdGVGaWxlKGNvbmZpZywgZmlsZW5hbWUsIHJlcS5ib2R5LCBjb250ZW50VHlwZSlcbiAgICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAxKTtcbiAgICAgICAgcmVzLnNldCgnTG9jYXRpb24nLCByZXN1bHQudXJsKTtcbiAgICAgICAgcmVzLmpzb24ocmVzdWx0KTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goZSA9PiB7XG4gICAgICAgIGxvZ2dlci5lcnJvcignRXJyb3IgY3JlYXRpbmcgYSBmaWxlOiAnLCBlKTtcbiAgICAgICAgbmV4dChcbiAgICAgICAgICBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICAgICAgICBQYXJzZS5FcnJvci5GSUxFX1NBVkVfRVJST1IsXG4gICAgICAgICAgICBgQ291bGQgbm90IHN0b3JlIGZpbGU6ICR7ZmlsZW5hbWV9LmBcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgfVxuXG4gIGRlbGV0ZUhhbmRsZXIocmVxLCByZXMsIG5leHQpIHtcbiAgICBjb25zdCBmaWxlc0NvbnRyb2xsZXIgPSByZXEuY29uZmlnLmZpbGVzQ29udHJvbGxlcjtcbiAgICBmaWxlc0NvbnRyb2xsZXJcbiAgICAgIC5kZWxldGVGaWxlKHJlcS5jb25maWcsIHJlcS5wYXJhbXMuZmlsZW5hbWUpXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKTtcbiAgICAgICAgLy8gVE9ETzogcmV0dXJuIHVzZWZ1bCBKU09OIGhlcmU/XG4gICAgICAgIHJlcy5lbmQoKTtcbiAgICAgIH0pXG4gICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICBuZXh0KFxuICAgICAgICAgIG5ldyBQYXJzZS5FcnJvcihcbiAgICAgICAgICAgIFBhcnNlLkVycm9yLkZJTEVfREVMRVRFX0VSUk9SLFxuICAgICAgICAgICAgJ0NvdWxkIG5vdCBkZWxldGUgZmlsZS4nXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgICAgfSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZmlsZU5vdEZvdW5kKHJlcykge1xuICByZXMuc3RhdHVzKDQwNCk7XG4gIHJlcy5zZXQoJ0NvbnRlbnQtVHlwZScsICd0ZXh0L3BsYWluJyk7XG4gIHJlcy5lbmQoJ0ZpbGUgbm90IGZvdW5kLicpO1xufVxuXG5mdW5jdGlvbiBnZXRSYW5nZShyYW5nZSkge1xuICBjb25zdCBwYXJ0cyA9IHJhbmdlLnJlcGxhY2UoL2J5dGVzPS8sICcnKS5zcGxpdCgnLScpO1xuICByZXR1cm4ge1xuICAgIHN0YXJ0OiBwYXJzZUludChwYXJ0c1swXSwgMTApLFxuICAgIGVuZDogcGFydHNbMV0gPyBwYXJzZUludChwYXJ0c1sxXSwgMTApIDogdW5kZWZpbmVkLFxuICB9O1xufVxuIl19